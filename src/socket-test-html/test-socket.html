<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Socket.IO Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        background: #f6f7fb;
        border-radius: 10px;
      }
      input,
      button {
        padding: 10px;
        margin: 5px 0;
      }
      #chat-area {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 150px;
        border-radius: 6px;
        background: white;
        overflow-y: auto;
      }
      .msg {
        margin-bottom: 8px;
        padding: 6px 10px;
        border-radius: 6px;
      }
      .me {
        background: #d1ffd6;
      }
      .other {
        background: #e8e8e8;
      }
    </style>
  </head>
  <body>
    <h2>Socket.IO Chat Test</h2>

    <div id="login-section">
      <h3>GiriÅŸ Yap</h3>
      <input id="email" placeholder="E-posta" /><br />
      <input id="password" type="password" placeholder="Åžifre" /><br />
      <button id="loginBtn">GiriÅŸ Yap</button>
    </div>

    <div id="chat-section" style="display: none">
      <h3>HoÅŸgeldin, <span id="username"></span> ðŸ‘‹</h3>

      <div>
        <label>Mesaj GÃ¶nderilecek KullanÄ±cÄ± ID:</label><br />
        <input id="receiverId" placeholder="AlÄ±cÄ± ID" />
      </div>

      <div id="chat-area"></div>

      <input id="message" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." style="width: 80%" />
      <button id="sendBtn">GÃ¶nder</button>
    </div>

<script>
const apiUrl = "http://localhost:5001";
let socket = null;
let currentUser = null;
let token = null;

document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const res = await fetch(`${apiUrl}/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });
  if (!res.ok) return alert("GiriÅŸ baÅŸarÄ±sÄ±z");

  const data = await res.json();
  token = data.data.accessToken;

  const payload = JSON.parse(atob(token.split(".")[1]));
  const userId = payload.sub;

  const userRes = await fetch(`${apiUrl}/user/${userId}/true`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  currentUser = (await userRes.json()).data;

  document.getElementById("username").textContent = currentUser.username;
  document.getElementById("login-section").style.display = "none";
  document.getElementById("chat-section").style.display = "block";

  socket = io(apiUrl, { auth: { token } });

  socket.on("connect", () => console.log("Socket baÄŸlandÄ±:", socket.id));

socket.on("newMessage", (msg) => {
    console.log("Yeni mesaj alÄ±ndÄ±:", msg);
  const chatArea = document.getElementById("chat-area");
  const div = document.createElement("div");
  div.classList.add("msg");
  div.classList.add(msg.sender?.id === currentUser.id ? "me" : "other");
  div.textContent = `${msg.sender.username}: ${msg.content}`;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
});
};

document.getElementById("sendBtn").onclick = () => {
  const content = document.getElementById("message").value;
  const receiverId = parseInt(document.getElementById("receiverId").value);
  if (!socket || !content || !receiverId) return;

  // senderId artÄ±k gÃ¶nderilmiyor
  socket.emit("sendMessage", { receiverId, content });
  document.getElementById("message").value = "";
};
</script>

  </body>
</html>
